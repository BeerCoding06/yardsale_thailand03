server {
    listen 80 default_server;
    server_name _ localhost 127.0.0.1;
    root /app;
    index index.php index.html;

    # Handle WordPress static files - exact prefix matches (highest priority)
    # Must come BEFORE PHP location blocks to prevent PHP processing
    location ^~ /wp-content/ {
        alias /app/wordpress/wp-content/;
        # Deny PHP files
        location ~ \.php$ {
            deny all;
            return 404;
        }
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # WordPress static files - prefix match (highest priority, before catch-all)
    location ^~ /wp-includes/ {
        rewrite ^/(.*)$ /wordpress/$1 break;
        root /app;
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    location ^~ /wp-admin/ {
        alias /app/wordpress/wp-admin/;
        # Deny PHP files
        location ~ \.php$ {
            deny all;
            return 404;
        }
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # Deny PHP files in WordPress static directories (fallback)
    location ~ ^/(wp-content|wp-includes|wp-admin)/.*\.php$ {
        deny all;
        return 404;
    }
    
    # Handle PHP API files in /server/api/php/
    location ~ ^/server/api/php/(.+\.php)(.*)$ {
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /app/server/api/php/$1;
        fastcgi_param PATH_INFO $2;
        fastcgi_param REQUEST_URI /server/api/php/$1$2;
    }
    
    # WordPress PHP files - handle all PHP requests
    location ~ ^/wordpress/(.+\.php)(.*)$ {
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /app/wordpress/$1;
        fastcgi_param PATH_INFO $2;
        fastcgi_param REQUEST_URI /wordpress/$1$2;
    }
    
    # Handle WordPress index.php specifically (when accessing /wordpress/)
    location = /wordpress/index.php {
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /app/wordpress/index.php;
        fastcgi_param REQUEST_URI /wordpress/index.php;
    }
    
    # WordPress permalink support - handle all WordPress routes
    location /wordpress {
        alias /app/wordpress;
        try_files $uri $uri/ /wordpress/index.php?$args;
    }
    
    # Handle WordPress root redirect
    location = /wordpress {
        return 301 /wordpress/;
    }
    
    # Redirect WordPress PHP files without /wordpress prefix
    location ~ ^/(wp-login\.php|wp-cron\.php|xmlrpc\.php) {
        return 301 /wordpress$request_uri;
    }
    
    # WordPress REST API and wp-json - handle both /wp-json and /wordpress/wp-json
    location ~ ^/(wordpress/)?wp-json(/.*)?$ {
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /app/wordpress/index.php;
        # Pass the full request URI to WordPress
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
    }
    
    # Handle WordPress custom routes (WooCommerce, custom post types, etc.)
    # These routes should be handled by WordPress index.php
    location ~ ^/(my-account|shop|product|cart|checkout|wc-api|yardsale_thailand)(/.*)?$ {
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /app/wordpress/index.php;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
    }

    # Nuxt application - must be last
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
